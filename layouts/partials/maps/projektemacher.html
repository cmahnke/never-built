{{- $context := .context -}}
{{- $geojson := .geojson -}}
{{- if eq $geojson nil -}}
  {{- $geojson = "undefined" -}}
{{- end -}}
{{- $source := .source -}}
{{- if eq $source nil -}}
  {{- $source = false -}}
{{- end -}}
{{- if and (not $source) site.Params.map site.Params.map.source -}}
  {{- $source = site.Params.map.source -}}
{{- end -}}
{{- $style := .style -}}
{{- if eq $style nil -}}
  {{- $style = "undefined" -}}
{{- end -}}
{{- if and (not $style) site.Params.map site.Params.map.style -}}
  {{- $style = site.Params.map.style -}}
{{- end -}}
{{- if eq $geojson nil -}}
  {{/* Check if we only got one param, this will be the geojson referece */}}
  {{- $geojson := . -}}
{{- end -}}

{{- $cluster := .cluster -}}
{{- if eq $cluster nil -}}
  {{- $cluster = false -}}
{{- end -}}

{{- $center := .center -}}
{{- if or (eq $center nil) (eq $center false) -}}
  {{- $center = "undefined" -}}
{{- end -}}

{{- $initialZoom := .initialZoom -}}
{{- if or (eq $initialZoom nil) (eq $initialZoom false) -}}
  {{- $initialZoom = 1 -}}
{{- end -}}

{{- $maxZoom := .maxZoom -}}
{{- if or (eq $maxZoom nil) (eq $maxZoom false) -}}
  {{- $maxZoom = 15 -}}
{{- end -}}

{{/*  center, initialZoom, maxZoom */}}
{{/* See https://openlayers.org/en/latest/apidoc/module-ol_style_Icon.html for options */}}
{{- $marker := .marker -}}
{{- if eq $marker nil -}}
  {{- $marker = "undefined" -}}
{{- end -}}
{{- if and (ne $marker "undefined") site.Params.map site.Params.map.marker -}}
  {{- $marker = site.Params.map.marker -}}
{{- end -}}

{{- $bbox := .bbox -}}
{{- if or (eq $bbox nil) (eq $bbox false) -}}
  {{- $bbox = "{}" -}}
{{- end -}}
{{- if and (eq $bbox "{}") site.Params.map site.Params.map.bbox -}}
  {{- $bbox = site.Params.map.bbox -}}
{{- end -}}

{{- $debug := .debug -}}
{{- if eq $debug nil -}}
  {{- $debug = false -}}
{{- end -}}

{{- $id := md5 $geojson -}}
{{- $var := printf "_%s" $id -}}
<div class="map-wrapper">
  <div class="map" id="{{ $id }}"></div>
  <div id="{{ $id }}-popup" class="ol-popup">
    <a href="#" id="{{ $id }}-popup-closer" class="ol-popup-closer"></a>
    <div id="{{ $id }}-popup-content"></div>
  </div>
</div>
<script type="text/javascript">
  {{/*
  var {{ $var | safeJS }} = window.projektemacherMap('{{ $id | safeJS }}', '{{ $geojson | safeJS }}', '{{  $source | safeJS}}', '{{ $style | safeJS }}', {{ $cluster | safeJS }}, '{{ $bbox | safeJS }}', {{ $center | safeJS }}, {{ $initialZoom | safeJS }}, {{ $maxZoom | safeJS }} {{ if $marker }}, {{ $marker | safeJS}}  {{ end }});
  */}}
    var {{ $var | safeJS }} = window.projektemacherMap(
      {{ partial "js/type.html" $id | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $geojson | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $source | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $style | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $cluster | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $bbox | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $center | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $initialZoom | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $maxZoom | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $debug | htmlUnescape | safeJS }},
      {{ partial "js/type.html" $marker | htmlUnescape | safeJS}});
      /*{{ if $marker }}, {{ $marker | safeJS}}  {{ end }});*/
  {{ $var | safeJS }}.then(map => {map.updateSize()});
</script>
